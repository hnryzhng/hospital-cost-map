<!DOCTYPE html>

<html>
	<head>
		<script src="https://d3js.org/d3.v4.min.js"></script>
		<script src="https://d3js.org/queue.v1.min.js"></script>
		<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>  


		<style>
			#submitButton {
				background-color: #4CAF50; /* Green */
				border: none;
				color: white;
				padding: 15px 32px;
				text-align: center;
				text-decoration: none;
				display: inline-block;
				font-size: 16px;				
			}

			#selectionContainer {
				width: 30%;
				height: 100%;
				float: left;
				overflow: scroll;
			}

			#dropdown_diseaseGroup {
				width: 80%;
			}

			#barChart {
				width: 90%;
				height: 100%;
			}

			#map {
				height: 100%;
				overflow: hidden;
			}

			#consoleDisplay {
				margin-left: 500px;
				height: 300px;
				width: 300px;	
			}

			html, body {
				height: 100%;
			}

			h1 {
				font-size: 1.8em;
			}

			#disclaimer {
				font-size: 0.8em;
			}		

		</style>


	</head>

	<body>
		<div id="selectionContainer">
			<h1> Q: How much will my procedure cost? </h1>
			<p id="disclaimer">The map is for reference only. In an emergency, please <b>dial 911</b> or a similar service for your optimal treatment location.</p>  

			<select id="dropdown_icd">
				<option>Select Diagnosis</option>
			</select>		

			<select id="dropdown_diseaseGroup">
				<option>Select Disease Group</option>
			</select>

			<div id="addressContainer">
				<input type="text" name="address" id="addressField" placeholder="ADDRESS" value="75 Colonial Springs Rd Gate #3, Wheatley Heights, NY 11798"><br>

			</div>

			<select id="dropdown_radius">
				<option> Radius </option>
				<option id="radius_5">5</option>
				<option id="radius_10">10</option>
				<option id="radius_50">50</option>
				<option id="radius_100">100</option>
			</select>
			
			<a href=#>
				<div id="submitButton">SUBMIT</div>
			</a>

			<div id="barChart"></div>

		</div>
		
		<div id="consoleDisplay"></div>

		<div id="map"></div>

		<script>

			// TASK: path and directions (find path time from center to each marker - GMaps Javascript Distance Matrix, provide option in label to show driving/walking directions - GMaps Javascript Directions)
			// TASK: create json of geocoded addresses by deploying Google Geocoder API on Heroku
			// TASK: put in cost data for each hospital for particular DRG (hospital, drg, cost map?)
			// TASK: glue ICD (ICD-11? need to scrape first)
			// TASK: UI

			
			// USER INPUT: DEFAULT PARAMETERS
			// TASK: cross-filter for addresses? Or Google alternative

			var address = "75 Colonial Springs Rd Gate #3, Wheatley Heights, NY 11798";
			var icd = "Transplantation of Heart, Allogeneic, Open Approach";
			var drgName = "014 - ALLOGENEIC BONE MARROW TRANSPLANT";
			var radius = 50;

			// POPULATE DROPDOWN
			function populateDropdown (newDataArray, icdtodrgcodemap) {
				var dropdownKeys = Object.keys(newDataArray);
				var icdKeys = Object.keys(icdtodrgcodemap);

				dropdownKeys.forEach(function(key, index){
					$("#dropdown_diseaseGroup").append('<option value='+JSON.stringify(key)+'>'+key+'</option>');
				});

				icdKeys.forEach(function(key, index){
					$("#dropdown_icd").append('<option value='+JSON.stringify(key)+'>'+key+'</option>');
				});

			};

			// WRANGLE DATA
			var wrangleData = function(dataArray) {
				/**
				output

				{drgA: [{address:val, hospital:val, cost:val}, {...}], drgB:[{...},{...}]}	
				**/
				var newDataArray = {};

				dataArray.forEach(function(record, index){
					//$("#consoleDisplay").append("<p>"+JSON.stringify(record)+"</p>");
				});

				function findAvgCost(totalcostStr, numdischargesStr) {
					// find average cost = num(totalcostStr) / num(numdischargesStr)
					var totalCost = parseFloat(totalcostStr.replace(/[^0-9\.-]+/g,""));	// rid of currency formatting, convert to floating point 					
					var numPatients = parseFloat(numdischargesStr);
					return (totalCost/numPatients).toFixed(0); 
				};
				
				// create records with desired format
				dataArray.forEach(function(record, index){
					//$("#consoleDisplay").append("<p>"+JSON.stringify(record["DRG Definition"])+"</p>");
					var currentDrg = record["DRG Definition"];	// TASK: process with regex

					var currentAddr = record["Provider Street Address"] + ", "; 
					currentAddr += record["Provider City"] + ", "; 
					currentAddr += record["Provider State"] + " "; 
					currentAddr += record["Provider Zip Code"];
					var currentHospital = record["Provider Name"];

					var totalPaymentsStr = record["Average Total Payments"];
					var numDischargesStr = record["Total Discharges"];
					var currentCost = findAvgCost(totalPaymentsStr, numDischargesStr);
					var newRecord = {
						"hospital":currentHospital,
						"address":currentAddr,
						"cost": parseInt(currentCost)
					};
					
					//$("#consoleDisplay2").append("<p>"+JSON.stringify(newRecord)+"</p>");

					// assign new record to array for associated DRG  
					if (currentDrg in newDataArray){
						newDataArray[currentDrg].push(newRecord);
					} else {
						newDataArray[currentDrg] = [newRecord];
					};

				});

				// $("#consoleDisplay2").append("<p>"+JSON.stringify(newDataArray)+"</p>");
				return newDataArray;				
			};
			
			function showDirections(fromLatLngObj, toLatLngObj) {
				// Google Maps Javascript API: Directions 
				var directionsService = new google.maps.DirectionsService();
				var directionsDisplay = new google.maps.DirectionsRenderer();
				/**
				var mapOptions = {
					center: fromLatLngObj;
				};
				var newMap = new.google.maps.Map(document.getElementById("map"), mapOptions);
				**/
				directionsDisplay.setMap(map);	// bind renderer to map 
				$("#consoleDisplay").append("<p>"+'show directions MAP: '+ JSON.stringify(map) + "</p>");

				var directionsRequest = {
					origin: fromLatLngObj,
					destination: toLatLngObj,
					travelMode: 'DRIVING'
				};

				directionsService.route(directionsRequest, function(response, status) {
					if (status === 'OK') {
						// $("#consoleDisplay").append("<p>"+'directions status response: ' + JSON.stringify(response) + "</p>");

						// PROBLEM: why is route not rendering on map? is it because of info window? try in maptest.html
						// https://stackoverflow.com/questions/9309285/google-maps-api-directions-result-not-showing
						// maybe map object is not rendering here

						directionsDisplay.setDirections(response);	// render route on map

						var routeObj = directionsDisplay.getDirections()	// retrieve route info

						//$("#consoleDisplay").append("<p>"+'directions status route obj: ' + JSON.stringify(routeObj) + "</p>");
						calcDistanceDuration(routeObj);	// return sum of route's distance and duration

						$("#consoleDisplay").append("<p>"+'set directions test: ' + "</p>");
					} else {
						$("#consoleDisplay").append("<p>"+'directions duration error: ' + "</p>");
					};
				});

				function calcDistanceDuration(routeObj) {
					var distanceTotal = 0;
					var durationTotal = 0;
					var myroute = routeObj.routes[0];
					for (var i=0; i < myroute.legs.length; i++) {
						distanceTotal += myroute.legs[i].distance.value;
						durationTotal += myroute.legs[i].duration.value;
					};
					distanceTotal = distanceTotal / 1000;	// convert to km
					durationTotal = (durationTotal/60).toFixed(0);	// convert to minutes
					$("#consoleDisplay").append("<p>"+'directions distance fn: ' + JSON.stringify(distanceTotal)+"</p>");
					$("#consoleDisplay").append("<p>"+'directions duration fn: ' + JSON.stringify(durationTotal)+"</p>");
				};

			};
			
			
			function calcDistPathTime(fromLatLngObjArray, matchingHospitalArray, map) {
				// Google Maps Javascript API Distance Matrix

				// fromLatLngObjArray: [centerLatLngObj]
				// toLatLngObjsArray: [toLatLngObjA, toLatLngObjB, ...]

				// extract lat lng objects, put into array 
				var toLatLngObjArray = [];
				for (var i=0; i<matchingHospitalArray.length; i++) {
					var record = matchingHospitalArray[i];
					toLatLngObjArray.push(record["latlngObj"]);
				}

				$("#consoleDisplay").append("<p>"+'calcDistPathTime userlatlng: ' + JSON.stringify(fromLatLngObjArray)+"</p>");
				$("#consoleDisplay").append("<p>"+'calcDistPathTime latlngobjarray: ' + JSON.stringify(toLatLngObjArray)+"</p>");

				var service = new google.maps.DistanceMatrixService();
				service.getDistanceMatrix({
					origins: fromLatLngObjArray,
					destinations: toLatLngObjArray,
					travelMode: 'DRIVING',
					unitSystem: google.maps.UnitSystem.IMPERIAL,
					avoidHighways: false,
					avoidTolls: false
				}, function(response, status){
					if (status !== 'OK') {
						$("#consoleDisplay").append("<p>"+'calcDistPathTime error: ' + JSON.stringify(status)+"</p>");
					} else {
						var originList = response.originAddresses;
						var destinationList = response.destinationAddresses;
						//$("#consoleDisplay").append("<p>"+'calcDistPathTime times: ' + JSON.stringify("test")+"</p>");
						//$("#consoleDisplay").append("<p>"+'distance destinations times: ' + JSON.stringify(response.rows[0])+"</p>");
						//$("#consoleDisplay").append("<p>"+'distance destinations test distance: ' + JSON.stringify(response.rows[0].elements[0].distance.text)+"</p>");
						//$("#consoleDisplay").append("<p>"+'distance destinations test duration: ' + JSON.stringify(response.rows[0].elements[0].duration.text)+"</p>");

						// add distance and duration to each hospital record
						for (var i=0; i<matchingHospitalArray.length; i++) {
							var record = matchingHospitalArray[i];
							
							// for each destination duration, distance (elements denote destination records)
							destinationRecords = response.rows[0].elements;
							for (var j=0; j<destinationRecords.length; j++) {		
								record["distance"] = destinationRecords[j].distance.text;
								record["duration"] = destinationRecords[j].duration.text;
							};
							$("#consoleDisplay").append("<p>"+'updated records: ' + JSON.stringify(record)+"</p>");
						};

						// create markers for each 
						createMarkers(matchingHospitalArray, map);
					};

				});

			};

			function createMarkers(hospitalArray, map) {
				for (var i=0; i<hospitalArray.length; i++) {

					record = hospitalArray[i];

					currentHospitalName = record["hospitalName"];
					currentHospitalAddress = record["address"];
					currentHospitalCost = record["cost"];
					currentlatlngObj = record["latlngObj"];
					currentDistance = record["distance"];
					currentDuration = record["duration"];

					infoContent = '<div class="infoWindow">' + 
									currentDistance + ',' + currentDuration + ',' + currentHospitalCost + 
									'<a href=# id="activateDirections">' +
									'CLICK ME' + 
									'</a>' + 
									'</div>';  

					var infoWindow = new google.maps.InfoWindow({
						content: infoContent
					});

					var currentMarker = new google.maps.Marker({
						position: currentlatlngObj,
						label: currentHospitalName,
						animation: google.maps.Animation.DROP,	
						map: map
					});					

					// event
					// TASK: bar chart 
					// add event so when I click the hospital's bar in sidebar's bar chart, the infowindow opens, zooms into marker (add unique id for each marker and each bar to correspond?)

					// event: info window on click
					currentMarker.addListener("click", function() {
						infoWindow.open(map,currentMarker);

						$("#consoleDisplay").append("<p>"+'info window content event'+ "</p>");

						// event: show directions
						// TASK: if click on directions link, then activate directions function
						// faq: https://stackoverflow.com/questions/3771299/google-maps-api-3-directions-adding-trip-duration-and-distance-to-infowindow?rq=1
						
						function directionsCallback() {

							// PROBLEM: won't show directions route; maybe map only loads once
							// HYPO SOLUTION: open a new window to load NEW map showing route for directions upon click? 

							//$("#consoleDisplay").append("<p>"+'info window ive been clicked!' + "</p>");
							//infoWindow.close();
							//$("#consoleDisplay").append("<p>"+'info window center coords:'+ JSON.stringify(map.getCenter()) + "</p>");					
							//$("#consoleDisplay").append("<p>"+'info window destination coords:'+ JSON.stringify(currentlatlngObj) + "</p>");
							
							$("#consoleDisplay").append("<p>"+'info window content CENTER'+ JSON.stringify(map.getCenter())+"</p>");
							showDirections(map.getCenter(), currentlatlngObj);
						}
						

						$("#activateDirections").on("click", directionsCallback);

					});


				};

			};


			function makeViz(dataArray) {
				// visualize array using D3
				

				d3.select("svg").remove();

				// create canvas
				var barChartDiv = document.getElementById("barChart");
				var width = barChartDiv.clientWidth;
				var height = barChartDiv.clientHeight;


				var canvas = d3.select("#barChart").append("svg")
								.attr("width",width)
								.attr("height",height)
									.append("g");  

				// create bars
				var bars = canvas.selectAll("rect")
								.data(dataArray);

					// add elements
					bars.enter()
						.append("rect");

					// update elements
					// TASK: open info window of corresponding marker upon clicking bar
					// perhaps have  a function that maps classes of bar and hospital marker/info window
					bars
						.attr("width",function(d,i,j){return (d.cost/width)*5;})
						.attr("height",10)
						.attr("fill","blue")
						.attr("y",function(d,i){return(i+1)*20})
						.on("click", function(){
							$("#barChart").append("<p>clicked on bar</p>")
						})
							.append("g");

					// remove elements
					bars.exit().remove();
				
				var barText = canvas.selectAll("text")
								.data(dataArray);

					// add
					barText.enter()
							.append("text");

					// update
					barText
						.text(function(d,i,j){return "$: "+d.cost.toString();})
						.attr("y",function(d,i,j){return (i+1)*20;})
						.attr("fill","black")
						.attr("font-size","10px");

					// remove
					barText.exit().remove();			



			};

			function showBarChart (dataArray) {

				// show top x closest hospitals based on prices (desc)
				// TASK: clicking on hospital a) zooms into hospital, b) displays infowindow

				//$("#barChart").append("<p>"+'unsorted: ' + JSON.stringify(dataArray)+"</p>");

				// sort records based on price (desc)
				function compare(a,b){
					if (a.cost < b.cost) 
						return 1;
					if (a.cost > b.cost)
						return -1;
					return 0;
				};

				var sortedArray = dataArray.sort(compare);

				//$("#barChart").append("<p>"+'sorted: ' + JSON.stringify(sortedArray)+"</p>");
				// filter top 5?


				// makeViz
				makeViz(sortedArray);


			};

			function calcMiles(fromLatLngObj, toLatLngObj) {
				var distance = google.maps.geometry.spherical.computeDistanceBetween(fromLatLngObj, toLatLngObj);	
				var distanceMiles = (distance * 0.000621371);
				$("#consoleDisplay").append("<p>"+'distance: ' + JSON.stringify(distance)+"</p>");
				$("#consoleDisplay").append("<p>"+'distance miles: ' + JSON.stringify(distanceMiles)+"</p>");
				$("#consoleDisplay").append("<p>"+'user defined radius: ' + JSON.stringify(radius)+"</p>");
				return distanceMiles;
			};



			function placeHospitalMarkers(userLatLngObj, map, newDataArray, latlngObj, drgName, radius, icddrgMap, drgList) {
				// local vars: newDataArray, latlngObj, map, userposition 
				// global vars: drgName, radius
				
				$("#consoleDisplay").append("<p>"+'placeHospitalMarkers: userposition' + JSON.stringify(userLatLngObj)+"</p>");
				//$("#consoleDisplay").append("<p>"+'placeHospitalMarkers drg: ' + JSON.stringify(drgName)+"</p>");


				// multiple drgs from input icd
 				var userDrgHospitalsArray = []; 			
				$("#consoleDisplay").append("<p>"+'placeHospitalMarkers drgList: ' + JSON.stringify(drgList)+"</p>");
				for (var i=0; i<drgList.length; i++) {
					// extract list of hospital records for particular drg
					var drgName = drgList[i];
					var hospitalrecordsList = newDataArray[drgName];

					// push all records in list of particular drg into a list 
					for (var j=0; j<hospitalrecordsList.length; j++) {
						var hospitalrecord = hospitalrecordsList[j];
						userDrgHospitalsArray.push(hospitalrecord);
					};
				};
//				var userDrgHospitalsArray = newDataArray[drgName];	// for single DRG 
				
				$("#consoleDisplay").append("<p>"+'userDrgHospitalsArray: ' + JSON.stringify(userDrgHospitalsArray)+"</p>");

				// create bounds object to fit new hospital markers
				// TASK: zoom level to fit markers
				// FAQ: https://stackoverflow.com/questions/3897744/automatically-adjust-zoom-to-accommodate-all-marker-in-a-google-map
				// var bounds = new google.maps.LatLngBounds();
				var matchingHospitalArray = [];
				var barChartArray = [];

				// grab array of hospital records for specified drg
				for (var i=0;i<userDrgHospitalsArray.length;i++) {
					var currentHospitalAddress = userDrgHospitalsArray[i]["address"];	
					var currentHospitalName = userDrgHospitalsArray[i]["hospital"];
					var currentHospitalCost = userDrgHospitalsArray[i]["cost"];

					$("#consoleDisplay").append("<p>"+'current address: ' + JSON.stringify(currentHospitalAddress)+"</p>");

					
					if (currentHospitalAddress in latlngObj) {
						var currentlatlng = latlngObj[currentHospitalAddress];	// get corresponding latlngObj of address
						currentlatlngObj = new google.maps.LatLng(currentlatlng["lat"],currentlatlng["lng"])
						$("#consoleDisplay").append("<p>"+'currentlatlng: ' + JSON.stringify(currentlatlng)+"</p>");

						// compute distance (displacement) between user and current hospital
						var distanceMiles = calcMiles(userLatLngObj, currentlatlngObj)
						
						// TASK: if current marker falls within specified radius of user position, then add marker and corresponding features (circles, color, content box, path time/distance -- infowindow/popup box)
						if (distanceMiles <= radius) {
							/**
							var currentMarker = new google.maps.Marker({
								position: currentlatlngObj,
								label: currentHospitalName,
								animation: google.maps.Animation.DROP,	
								map: map
							});
							**/

							var currentHospitalRecord = {
								"hospitalName": currentHospitalName,
								"address": currentHospitalAddress,
								"cost": currentHospitalCost,
								"latlngObj": currentlatlngObj
							};

							matchingHospitalArray.push(currentHospitalRecord);

							barChartArray.push(userDrgHospitalsArray[i]);	// put record into array for showBarChart 
							
						};
					};

				}; 



				// sidebar bar chart 
				$("#consoleDisplay").append("<p>"+'barChartArray: ' + JSON.stringify(barChartArray)+"</p>");
				showBarChart(barChartArray);

				// compute path distance using destination latlng objects
				calcDistPathTime([userLatLngObj], matchingHospitalArray, map);
				$("#consoleDisplay").append("<p>"+'matchingHospitalArray: ' + JSON.stringify(matchingHospitalArray)+"</p>");
				//map.setCenter(bounds.getCenter);
				//map.setZoom(6);
				//map.fitBounds(bounds);	// works for multiple markers, use setZoom is only one

			};

			function geocodeUserAddress(address, map, newDataArray, latlngObj, drgName, radius, icddrgMap, drgList) {
				// Google Maps Javascript API Geocoding: https://developers.google.com/maps/documentation/javascript/examples/geocoding-simple
				geocoder = new google.maps.Geocoder();
				geocoder.geocode({'address':address}, function(results, status){
					if (status === 'OK') {
						addresslatlngObj = results[0].geometry.location;
						map.setCenter(addresslatlngObj);
						new google.maps.Marker({
							position: addresslatlngObj,
							map: map
						});
						$("#consoleDisplay").append("<p>"+'user address input: ' + JSON.stringify(address)+"</p>");
						$("#consoleDisplay").append("<p>"+'geocoded address lat lng: ' + JSON.stringify(addresslatlngObj)+"</p>");
						// addresslatlngObj is already LatLng object
						placeHospitalMarkers(addresslatlngObj, map, newDataArray, latlngObj, drgName, radius, icddrgMap, drgList);

					} else {
						$("#consoleDisplay").append("<p>"+'geocoded user address: ' + 'there was an error with your address' +"</p>");	
					};
				});			
			};

			function geolocateUser(map, newDataArray, latlngObj) {
				// Google Maps Javascript API Geolocation
				if (navigator.geolocation) {
					// if browser supports or user allows geolocation 
					navigator.geolocation.getCurrentPosition(function(position){
						userposition = {
							lat: position.coords. latitude,
							lng: position.coords.longitude
						};

					map.setCenter(userposition);

					new google.maps.Marker({
						position: userposition,
						map: map						
					});					

					$("#consoleDisplay").append("<p>"+'geolocated userposition: ' + JSON.stringify(userposition)+"</p>");	
					});
				} 
				else {
					$("#consoleDisplay").append("<p>"+'geolocated userposition: ' + JSON.stringify('does not support geolocation')+"</p>");						
				}
			};

			function initMap(newDataArray, latlngObj, address, drgName, radius, icddrgMap, drgList) {
				// Google Maps Javascript API
				startLatLngObj = new google.maps.LatLng(39.0904811, -108.5627055);
				$("#consoleDisplay").append("<p>"+'initMap startLatLngObj: ' + JSON.stringify(startLatLngObj)+"</p>");

				// initialize map
				var map = new google.maps.Map(document.getElementById("map"),{
					zoom: 10,
					center: startLatLngObj
				});

			
				// starting position
				if (address === "") {
					// geolocate
					// TASK: make this work, as it doesn't connect with placehospitalmarkers() 
					geolocateUser(map, newDataArray, latlngObj);
				} else {
					// grab geocoded user address
					geocodeUserAddress(address, map, newDataArray, latlngObj, drgName, radius, icddrgMap, drgList);
				};

				// $("#consoleDisplay").append("<p>"+'latlngObj: ' + JSON.stringify(latlngObj)+"</p>");
				// $("#consoleDisplay").append("<p>"+'newDataArray: ' + JSON.stringify(newDataArray)+"</p>");
			};

			function getlatlngArray(newDataArray, address, drgName, radius, icddrgMap, drgList) {
				// get array of addresses with corresponding geocoded objects
				// Geocoding API
				// geocode on backend; Google's API has free daily quota of 2500, making it prohibitive for client-side requests

				$.getJSON('geocoded_addresses.txt', function(latlngObj){
					//$("#consoleDisplay").append("<p> latlngObj:"+JSON.stringify(latlngObj)+"</p>");
					//$("#consoleDisplay").append("<p> latlngObj type: "+(typeof latlngObj)+"</p>");
					//$("#consoleDisplay").append("<p>getlatlngArray fn newDataArray: "+JSON.stringify(newDataArray)+"</p>");
					initMap(newDataArray, latlngObj, address, drgName, radius, icddrgMap, drgList);
				});
			};


			function mapICDtoDRG (icd, icddrgMap, icdtodrgcodemap, drgcodetonamemap) {
				// icdtodrgcode[icd] = {drgcodea: null, drgcodeb: null}
				// extract all drgcodes as keys into drgcodeslist
				// for each drgcode in drglist, extract matching name from drgcodetoname into obj
				// return drgNamesList of drgs matching icd

				//$("#consoleDisplay").append("<p>"+'mapicdtodrg icdtodrgcodemap: ' + JSON.stringify(icdtodrgcodemap)+"</p>");
				//$("#consoleDisplay").append("<p>"+'mapicdtodrg drgcodetonamemap: ' + JSON.stringify(drgcodetonamemap)+"</p>");


				var drgList = [];
				if (icdtodrgcodemap.hasOwnProperty(icd)) {
					var drgObj = icdtodrgcodemap[icd];
					var drgCodesList = Object.keys(drgObj);

					for (var i=0; i<drgCodesList.length; i++) {
						var drgCode = drgCodesList[i];
						var drgName = drgcodetonamemap[drgCode];
						drgList.push(drgName);
					};

					$("#consoleDisplay").append("<p>"+'mapicdtodrg fn drgList: ' + JSON.stringify(drgList)+"</p>");

					return drgList

				} else {
					$("#consoleDisplay").append("<p> mapicdtodrg icd could not be found</p>");
				};
			};

			function eventListeners(newDataArray, icddrgMap, icdtodrgcodemap, drgcodetonamemap){

					function update() {
						// update input values
						var address = $("#addressField").val();
						var icd = $("#dropdown_icd").val();
						var drgName = $("#dropdown_diseaseGroup").val();
						var radius = $("#dropdown_radius").val();
						// $("#consoleDisplay").append("<p>"+'dynamic address: ' + JSON.stringify(address)+"</p>");
						// $("#consoleDisplay").append("<p>"+'dynamic disease: ' + JSON.stringify(drgName)+"</p>");
						// $("#consoleDisplay").append("<p>"+'dynamic radius: ' + JSON.stringify(radius)+"</p>");				

						// map icd to drg

						var drgList = mapICDtoDRG(icd, icddrgMap, icdtodrgcodemap, drgcodetonamemap);

						getlatlngArray(newDataArray, address, drgName, radius, drgList);

					};

					// call event listeners
					$("#dropdown_icd").on("change",update);	// icd
					$("#dropdown_diseaseGroup").on("change",update);	// drg
					$("#dropdown_radius").on("change",update);	// radius

					$("#submitButton").on("click",update)	// address submit button
					$("#addressField").keypress(function(event){
						// pressing "Enter" for address input
						if (event.which == 13) {
							update();
						}
					});
			};


			function main (){
				// backend: submit user icd input -> hospital records list through AJAX


				// rid of populateDropdown()

				// put hospitalrecordslist through getlatlngarray

				// future: go straight to initmap(), rid of getlatlngarray by grabbing geocoded objects of user's address and matching hospitals from backend? (instead of returning hospitalrecordslist with just addresses, grab hospital records list with geocoded objects after backend processing, then put through to placeHospitalMarkers())
				// 

				// event listeners: update through AJAX
			};

			```
			// CALL FUNCTIONS
			function main() {
				
				// load multiple files using d3 queue
				// faq: https://stackoverflow.com/questions/39056789/how-to-fetch-data-from-multiple-json-for-creating-a-barchart-using-d3-js
				queue()
					.defer(d3.csv, 'inpatient2016.csv')
					.defer(d3.json, 'icddrgMap.txt')
					.defer(d3.json, 'icd2drgCodeMap.txt')
					.defer(d3.json, 'drgCode2Name.txt')
					.await(loadFunctions);

				function loadFunctions(error, dataArray, icddrgMap, icdtodrgcodemap, drgcodetonamemap) {
					if (error) throw error;
							//$("#consoleDisplay").append("<p>"+'icdtodrgcodemap: ' + JSON.stringify(icdtodrgcodemap)+"</p>");
							//$("#consoleDisplay").append("<p>"+'drgcodetonamemap: ' + JSON.stringify(drgcodetonamemap)+"</p>");
							// TASK: replace icd dropdown with search function instead

							newDataArray = wrangleData(dataArray);	// TASK: separate wrangleData as independent process			
							$("#consoleDisplay").append("<p>"+'newDataArray: ' + JSON.stringify(newDataArray)+"</p>");
						
							populateDropdown(newDataArray, icdtodrgcodemap);

							var drgList = mapICDtoDRG(icd, icddrgMap, icdtodrgcodemap, drgcodetonamemap);
							getlatlngArray(newDataArray, address, drgName, radius, icddrgMap, drgList);
							//$("#consoleDisplay").append("<p>"+'main drgList: ' + JSON.stringify(drgList)+"</p>");

							// event listener: on change in user parameters
							eventListeners(newDataArray, icddrgMap, icdtodrgcodemap, drgcodetonamemap);



				};
			};
			```

		</script>
		<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCn0rDLKNGLIuCnu9jA6ETfWSoKCRiiafg&libraries=geometry&callback=main"></script>		

	</body>


	<footer>

	</footer>

</html>	