<!DOCTYPE html>

<html>

	<head>

		<script src="https://d3js.org/d3.v4.min.js"></script>

		<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script> 			
		<style>

			#displayContainer {
				width: 300px;
				height: 500px;
				position: fixed;
				z-index: 100;
				background-color: white;
			}

			#inputContainer {
				border: 1px solid red;
				position: fixed;
				background-color: white;
			}

			#submitButton {
				background-color: #4CAF50; /* Green */
				border: none;
				color: white;
				padding: 15px 32px;
				text-align: center;
				text-decoration: none;
				display: inline-block;
				font-size: 16px;
			};

			#text-box {
				width: 200px;
			};

			#results-display {
				width: 200px;
				height: 300px;
				border: 1px solid green;
			}

			.active {
				border: 1px solid red;
			}

			#bar-chart-container {
				width: 90%;
				height: 300px;
				background-color: white;
				border: 1px solid green;
			}

			#bar-chart {
				width: 90%;
				height: 300px;
			}

			#map {
				width: 100%;
				height: 700px;
				overflow: hidden;
				border: 1px solid blue;
				z-index: 99;
			}

		</style>

	</head>

	<body>

		<div id="displayContainer" class="container">

			<div id="inputContainer">
				<input type="text" id="text-box" name="ajaxtext" placeholder="Search operation type here" value="Transplantation of Heart, Allogeneic, Open Approach">
				<div id="results-display"></div>

				<input type="text" name="address" id="address-box" placeholder="ADDRESS" value="75 Colonial Springs Rd Gate #3, Wheatley Heights, NY 11798"><br>

				<select id="radius-dropdown">
					<option> Radius </option>
					<option id="radius_5">5</option>
					<option id="radius_10">10</option>
					<option id="radius_50" selected="selected">50</option>
					<option id="radius_100">100</option>
				</select>

				<div id="submitButton"></div>
			</div>

			<div id="bar-chart-container">
				<div id="bar-chart"></div>
			</div>

		</div>

		<div id="map"></div>

		<script>

			/*
			TO-DO
			a) figure out Google Maps API for Node JS
			b) see if initMap should be within grabResponse, or the other way around
			c) change var names: (addresslatlngObj -> userGeocodedObj, latlngObj -> hospitalGeocodedObj, placeHospitalMarkers() -> filterHospitalRecords)
			d) finish all tasks
			e) nest helper functions?
			*/
			
			// DEFAULT PARAMS
			//var address = "75 Colonial Springs Rd Gate #3, Wheatley Heights, NY 11798";
			//var userIcd = "Transplantation of Heart, Allogeneic, Open Approach";	
			//var radius = 50;



			function makeViz(sortedRecords) {
				// make bar chart using D3
				// PROBLEM: v3 or v4?

				// remove previous bar chart if available
				// d3.select("svg").remove();

				// create canvas 
				var barChartDiv = document.getElementById("bar-chart");
				var width = barChartDiv.clientWidth;
				var height = barChartDiv.clientHeight;


				var widthScale = d3.scaleLinear()
									.domain([0, d3.max(sortedRecords.map(function(d){return d.cost;}))])	// create new array based on cost, then find max cost
									.range([0, width]);


				// TASK: create height scale (map num of records to height)

				var canvas = d3.select("#bar-chart").append("svg")
								.attr("width", width)
								.attr("height", height)
									.append("g");
				// create bars
				var bars = canvas.selectAll("rect")
								.data(sortedRecords);
				// add elements
				// use block below once user input is incorporated so that bars can be updated
				bars.enter()
					.append("rect")
					.attr("width", function(d,i){return widthScale(d.cost);})
					.attr("height", 10)
					.attr("fill", "blue")
					.attr("y", function(d,i){return(i+1)*20;})

				/*

				// add elements
				bars.enter()
					.append("rect")

				// update elements
				// TASK: add event that opens corresponding marker when on hover or click? add id or class to bar?
				bars
					.attr("width", function(d,i){return (d["cost"]);})
					.attr("height", 10)
					.attr("fill", "blue")
					.attr("y", function(d,i){return(i+1)*20;})
					.on("click", function(){
						$("#bar-chart").append("<p>clicked on bar</p>")
					})
						.append("g");
				// remove old elements
				bars.exit().remove();
				*/

				/*
				// create bar text
				// TASK: or pop up on hover (collapsible)
				var barText = canvas.selectAll("text")
									.data(sortedRecords);

				barText.enter()
						.append("text");

				barText
					.text(function(d){return `$: ${d.cost}`;})
					.attr("y", function(d,i){return (i+1)*20;})
					.attr("fill", "black")
					.attr("font-size", "10px")

				barText.exit().remove();
				*/

			};

			function showBarChart(filteredRecords) {
				// show top x closest hospitals in descending order of cost
				// TASK: add event to locate marker when hover over bar?

				// BOOKMARK 3

				// sort records based on cost (desc)
				function compare(a,b){
					if (a.cost < b.cost)
						return 1
					if (a.cost > b.cost)
						return -1
					return 0
				};

				// TASK: filter top 5?
				// TASK: add to eventListener() to pop up bar chart after user submits? or only if bar chart is available?
				var sortedRecords = filteredRecords.sort(compare);
				//console.log("bar chart sorted records:", sortedRecords);
				makeViz(sortedRecords);


			};


			function createMarkers(userIcd, filteredRecords, map) {

				function buildMarker(record) {
					// helper function
					// create marker and info window in function separate from loop so as not to overwrite the marker
					var hospital = record["hospital"];
					var address = record["address"];
					var cost = record["cost"];
					var geocodedObj = record["geocoded_address"];
					var durationDriving = record["duration_driving"];
					var distanceDriving = record["distance_driving"];

					//console.log("create markers record:", record);


					// create info window					
					// PROBLEM: userIcd var may not be global
					// PROBLEM: make sure hospital returned matches the icd
					var infoContent = `<div class="info-window" id="${hospital}">
										<p class="info-hospital">${hospital}</p>
										<p class="user-icd">${userIcd}</p>
										<p class="info-cost">Cost: ${cost}</p>
										<p class="info-duration">Driving time: ${durationDriving}</p>
										<p class="info-distance">Driving distance: ${distanceDriving}</p>
										<p class="info-address">Address: ${address}</p>
									</div>`;

					var infoWindow = new google.maps.InfoWindow({
						content: infoContent
					});

					//console.log("infoContent:", infoContent);

					// create marker
					var marker = new google.maps.Marker({
						position: geocodedObj,
						map: map,
						label: hospital,
						animation: google.maps.Animation.DROP
					});

					//console.log("marker hospital label:", hospital)
					// event: 
					// TASK: add event so when I hover over bar chart, it zooms into/highlights marker (add identifiers to markers?); somehow connect with bar chart viz

					// event: info window on click
					marker.addListener("click", function() {

						infoWindow.open(map, this);

						map.addListener("click", function() {
							// close info window if clicking anywhere on map
							infoWindow.close(map, this);
						});

					});

				};


				// PROCESSING LOOP: run to create markers and info window
				for (var i=0; i<filteredRecords.length; i++) {
					record = filteredRecords[i];
					buildMarker(record);
				};

			};


			function calcDistPathTime(userIcd, addresslatlngObj, filteredRecords, map) {

				// calc driving distance using Google's Maps API Distance Matrix

				// put destination geocoded objects into array 
				var destinationsArray = [];
				for (var i=0; i<filteredRecords.length; i++) {
					var geocodedObj = filteredRecords[i]["geocoded_obj"];	// or just geocoded_address?
					destinationsArray.push(geocodedObj);
					//console.log("calc dist path time geocoded obj: ", geocodedObj);
				};

				// use API to produce corresponding driving distances from destination array
				var service = new google.maps.DistanceMatrixService();

				service.getDistanceMatrix({
					origins: [addresslatlngObj],
					destinations: destinationsArray,
					travelMode: 'DRIVING', 
					unitSystem: google.maps.UnitSystem.IMPERIAL,
					avoidHighways: false,
					avoidTolls: false
				}, function(response, status) {
					if (status !== 'OK') {
						console.log('calcDistPathTime error:', JSON.stringify(status));
					} else {
						// successful return
						var originArray = response.originAddresses;
						var destinationList = response.destinationAddresses;

						// add distance, duration to each hospital record
						for (var i=0; i<filteredRecords.length; i++) {
							var record = filteredRecords[i];

							// for each destination duration, distance, add to record
							// TASK: IF RECORD'S ADDRESS MATCHES WITH API DESTINATION RECORD ADDRESS, THEN ADD DISTANCE, DURATION TO THE RECORD (LOOK AT DESINATION RECORD STRUCTURE TO EXTRACT INFO)

							var destinationRecords = response.rows[0].elements;
							//console.log("distance matrix api destination records array: ", destinationRecords);
							
							record["distance_driving"] = destinationRecords[i].distance.text;
							record["duration_driving"] = destinationRecords[i].duration.text;
							console.log("updated records with driving distance, duration", JSON.stringify(record));

						};

						// create marker for each updated hospital record
						createMarkers(userIcd, filteredRecords, map);


					}
				});	// end getDistanceMatrix method

			};


			function calcMiles(fromGeoCoords, toGeoCoords) {
				// calc miles between two given geocoord objects
				var distance = google.maps.geometry.spherical.computeDistanceBetween(fromGeoCoords,toGeoCoords);
				var distanceMiles = (distance * 0.000621371);
				//console.log("calc miles:", distanceMiles);

				return distanceMiles;

			};


			function placeHospitalMarkers(map, userIcd, addresslatlngObj, radius, hospitalRecordsList) {
				// latlngObj => hospitalRecordsList
				console.log('placeHospitalMarkers() hospitalRecordsList: ' + hospitalRecordsList.toString()); 

				// filter only hospitals within selected radius

				var filteredRecords = [];
				for (var i=0; i<hospitalRecordsList.length; i++) {
					record = hospitalRecordsList[i];
					var geocodedAddress = record["geocoded_address"];
					var hospitalGeocodedObj = new google.maps.LatLng(geocodedAddress["lat"],geocodedAddress["lng"]);	// convert to lat lng object

					var distanceMiles = calcMiles(addresslatlngObj, hospitalGeocodedObj);

					// if hospital coords fall within radius
					if (distanceMiles <= radius) {
						// filter record for further processing
						record["geocoded_obj"] = hospitalGeocodedObj;
						filteredRecords.push(record)
					};

				};
				//console.log("filtered hospital records: ", filteredRecords);

				
				// pass filtered records for further processing
				calcDistPathTime(userIcd, addresslatlngObj, filteredRecords, map);

				// pass filteredRecords to make bar chart viz
				//showBarChart(filteredRecords);


			};			

			function geocodeUserAddress(map, userIcd, address, radius, hospitalRecordsList) {
				// Google Maps Javascript API Geocoding: https://developers.google.com/maps/documentation/javascript/examples/geocoding-simple
				geocoder = new google.maps.Geocoder();
				geocoder.geocode({'address':address}, function(results, status){
					if (status === 'OK') {
						var addresslatlngObj = results[0].geometry.location;
						map.setCenter(addresslatlngObj);
						new google.maps.Marker({
							position: addresslatlngObj,
							map: map
						});

						//$("#consoleDisplay").append("<p>"+'user address input: ' + JSON.stringify(address)+"</p>");
						//$("#consoleDisplay").append("<p>"+'geocoded address lat lng: ' + JSON.stringify(addresslatlngObj)+"</p>");
						// addresslatlngObj is already LatLng object
						placeHospitalMarkers(map, userIcd, addresslatlngObj, radius, hospitalRecordsList);
					} else {
						console.log('geocodeUserAddress(): there was an error with your address');	
					};
				});

			};

			function initMap(userIcd, address, radius, hospitalRecordsList) {
				// Google Maps Javascript API

				// Google Maps for Node JS
				// https://github.com/moshen/node-googlemaps
				// https://github.com/googlemaps/google-maps-services-js
				// hide API key 
				// https://stackoverflow.com/questions/52056077/google-maps-api-using-express-and-node-js


				startLatLngObj = new google.maps.LatLng(39.0904811, -108.5627055);
				console.log('initMap startLatLngObj: ' + JSON.stringify(startLatLngObj));

				// initialize map
				var map = new google.maps.Map(document.getElementById("map"),{
					zoom: 10,
					center: startLatLngObj
				});

				// starting position
				if (address === "") {
					// geolocate
					// TASK: make this work, as it doesn't connect with placehospitalmarkers() 
					// geolocateUser(map, newDataArray, latlngObj);
				} else {
					// grab geocoded user address
					geocodeUserAddress(map, userIcd, address, radius, hospitalRecordsList);
				};


			};

			function grabResponse(userIcd, address, radius) {
				// submit through ajax, and return response text

				// express js + ajax		
				// https://medium.freecodecamp.org/getting-off-the-ground-with-expressjs-89ada7ef4e59

				// good example: https://gist.github.com/diorahman/1520485
				
				// https://grokonez.com/node-js/integrate-nodejs-express-jquery-ajax-post-get-bootstrap-view#Implement_JQuery_Ajax_requests 

				
				//$('#text-box').val();

				// submit userIcd (global var)
				console.log('grabResponse(userIcd, address, radius) text input: '+(userIcd.toString()));

				function ajaxSuccess(response){
					console.log('gb ajax success');
					
					console.log('ajax response data:'+JSON.stringify(response));
					
					for (var i=0; i<response.length; i++) {
						console.log('ajax response record:'+JSON.stringify(response[i]));
					};

					var hospitalRecordsList = response;

					// pass to initmap for further processing
					initMap(userIcd, address, radius, hospitalRecordsList);

				};

				function ajaxFail(error){
					console.log('gb ajax failure');
					console.log('ajax error: '+JSON.stringify(error));
					//console.log("ajax fail:", error);

				};

				var targetUrl = "http://localhost:3000/get_hospital_records/"+userIcd;
				$.ajax({
					type: "GET",
					url: targetUrl,	// root+rel path or port num (8080,3000?)+rel path
					data: JSON.stringify(userIcd),	// use module for security
					success: ajaxSuccess, 
					error: ajaxFail
				});	
			};


			function autocomplete() {
				// defines events for choosing and selecting filtered icd results

				/**
				autocomplete feature:
				https://www.w3schools.com/howto/howto_js_autocomplete.asp
				detecting which element was clicked with jQuery

				simple version
				first hook up to userIcd parameter in grabResponse through on click of list item using mouse				

				pseudo-code:
				-on press of down or up arrow in text-box
				-results-display goes to corresponding list item
				-list item gains .activate class, with corresponding css style (remove .activate class from previous list item first)
				-on pressing enter in text-box, if any list item has .activate class, grab text content of item
				-hook text content of item to usericd in grabResponse (by returning text content here, then passing as parameter to grabResponse?)
				**/ 

				// add event: if input has a value, and results display has child items, then css display results display, perhaps this event handler wraps all else

				
				var resultsDisplay = document.getElementById("results-display");
				var childrenList = resultsDisplay.children;
				var textField = document.getElementById("text-box");
				var submitButton = document.getElementById("submitButton");
				var index = -1;

				function removeActive(childrenList) {
					for(var i=0;i<childrenList.length;i++){
						childrenList[i].classList.remove("active");
					}
				};

				// autocomplete event: click generated list item
				function clickEvents() {
					function addChildClickEvent(selectedChild) {
						// keep separate from loop to avoid overwriting previous variables in loop; maintain independent namespace

						selectedChild.addEventListener("mouseover", function(event){
							console.log("child selected:", selectedChild.textContent);
							removeActive(childrenList);
							selectedChild.classList.add("active");
							event.stopPropagation();	// stop child event from bubbling up to parent, avoiding redundant trigger of event
						});

						selectedChild.addEventListener("click", function(event){

							submitButton.click();
						})
					}

					
					resultsDisplay.addEventListener("mouseover", function(event){
						//console.log("click results display");

						for (var i=0; i<childrenList.length; i++) {
							var selectedChild = childrenList[i];
							addChildClickEvent(selectedChild)
						}

					});
				};
				

				// autocomplete event: select generated list item with arrow keys
				function arrowEvents() {
					
					function selectResultDOM(childrenList) {
						//console.log("event index:", index);
						//console.log("children list:", childrenList);

						// simulate cycling through list
						if (index >= childrenList.length) index = 0;
						if (index < 0) index = childrenList.length-1;

						var selectedChild = childrenList[index];
						console.log("select result index:", index);
						console.log("select result dom user icd: ", selectedChild.textContent);

						// remove active class on all list items
						removeActive(childrenList);

						// add active class to selected list item
						selectedChild.classList.add("active");
					}
					
					textField.addEventListener("keydown", function(event){
						
						if (event.keyCode == 38) {
							// up arrow
							event.preventDefault();
							index--
							selectResultDOM(childrenList);
						} else if (event.keyCode == 40) {
							// down arrow
							event.preventDefault();
							index++
							selectResultDOM(childrenList);
						} else if (event.keyCode == 13) {
							// enter key
							// event in userInputEventListeners
							submitButton.click();
						}
					});

				};


				// CALL AUTOCOMPLETE EVENTS
				arrowEvents();
				clickEvents();

			};


			function fastFilterInputWrapper() {

				// hook selected icd (selectedIcd) from autocomplete to userIcd in grabResponse

				// use DOM methods instead of jQuery for performance

				// define variables, functions
				var filteredList = [];
				var maxDisplay = 3;
				var textField = document.querySelector("#text-box");
				//textField.defaultValue = "Type in a type of surgery";	// set default value, because filter will return all results given an empty string
				var resultsDisplay = document.querySelector("#results-display");


				function generateListItem(item) {
					// create html elements for the matching item
					var li = document.createElement("li");
					// set classes for elements
					li.classList.add("result");
					// set text content
					li.textContent = item;

					return li;
				};


				function generateResults(filteredList) {
					// processing loop for generating html that match items given search term from filtered list
					var htmlFrag = document.createDocumentFragment();	// holds all list html elements then appends all at once, reducing load on DOM, instead of createElement()
					for (var i=0; i<filteredList.length; i++) {
						if (i < maxDisplay) {
							var item = filteredList[i];
							li = generateListItem(item);
							htmlFrag.appendChild(li);
						}
						else break;
					};

					resultsDisplay.innerHTML = "";	// clear display defined in global variable
					resultsDisplay.appendChild(htmlFrag);	// appends all html list items in fragment

				};

				function inputMatch(item) {
					// check if user input can be found in list item
					var searchText = textField.value.toLowerCase();
					var itemText = item.toLowerCase();
					/*
					if (itemText.indexOf(searchText) !== -1) {
						//console.log("input match search text:", searchText);
						//console.log("input match item text:", itemText);						
					};
					*/

					if (itemText.indexOf(searchText) !== -1) {
						return itemText;
					} else {
						return null;
					}
				};

				function getFilteredItems(icdList) {
					filteredList = icdList.filter(inputMatch);
					generateResults(filteredList);
				}

				function testcallback(icdList) {
					console.log("test icd list item 0:", icdList[0]);
				}

				function callback(icdList) {
					return function () {
						// closure function holds the state of the variables passed into a callback, allowing parameters to be passed into callback

						//console.log("callback icd list: ", icdList);
						//testcallback(icdList);
						getFilteredItems(icdList);
					}
				}

				// load json object of icd
				$.getJSON("/static/icd2drgCode.txt", function(dataObj){
					//console.log("icd map object keys:", Object.keys(dataObj));

					// convert to list of keys for search
					var icdList = Object.keys(dataObj);
					//console.log("fast filter icd list: ", icdList);

					// event: on typing in text field 
					textField.addEventListener("input", callback(icdList));


				});
			}

			function searchFunctions() {
				autocomplete();
				fastFilterInputWrapper();
			}

			function userInputEventListeners() {

				function update() {
					var userIcd = document.getElementsByClassName("active")[0].textContent;
					var address = $("#address-box").val();
					var radius = $("#radius-dropdown").val();
					
					//console.log("event listener target user icd:", userIcd);
					//console.log("event listener address:", address);
					//console.log("event listener radius:", radius);
					//console.log("submitbutton was clicked");
					
					// initiate next step
					grabResponse(userIcd, address, radius);
					
				}

				// event: for text box events, refer to autocomplete()

				// event: on click submit, update
				$("#submitButton").on("click", update);

				
			};

			function main() {

				// default parameters
				var defaultUserIcd = $("#text-box").val();	// geolocate user?
					defaultAddress = $("#address-box").val();
					defaultRadius = $("#radius-dropdown").val();


				// call grab response upon initial page load
				grabResponse(defaultUserIcd, defaultAddress, defaultRadius);

				searchFunctions();

				userInputEventListeners();

			};


			// Call function, or call with Google API in following script tag 
			//$(document).ready(main());

		</script>
		<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCn0rDLKNGLIuCnu9jA6ETfWSoKCRiiafg&libraries=geometry&callback=main"></script>	

	</body>





</html>